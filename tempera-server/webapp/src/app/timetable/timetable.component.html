<p-toast></p-toast>
<ng-container *ngIf="tableEntries; else loading">
  <p-table #table [value]="tableEntries" [globalFilterFields]="filterFields"
           (onFilter)="calculateTotalTime()" [rows]="7" [paginator]="true" sortField="startTime" [sortOrder]="1">
    <ng-template pTemplate="header">
      <tr>
        <th id="start" pSortableColumn="startTime">Start
          <p-sortIcon field="startTime"></p-sortIcon>
        </th>
        <th id="end">End</th>
        <th id="project">Project
        </th>
        <th id="state">State</th>
        <th id="description">Description</th>
        <th id="blank1"></th>
      </tr>
      <!--    Filters     -->
      <tr>
        <th id="startTimeFilter">
          <p-columnFilter type="date" field="startTime" placeholder="Search"></p-columnFilter>
        </th>
        <th id="endTimeFilter">
          <p-columnFilter type="date" field="endTime" placeholder="Search"></p-columnFilter>
        </th>
        <th id="projectFilter">
          <p-columnFilter field="assignedProject.projectId" [showMenu]="true"
                          [showClearButton]="false">
            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
              <p-dropdown
                [options]="availableProjects" [showClear]="true"
                (onChange)="filter($event.value?.projectId)"
                optionLabel="name" appendTo="body" placeholder="Select one"></p-dropdown>
            </ng-template>
          </p-columnFilter>
        </th>
        <th id="stateFilter">
          <p-columnFilter field="state" [showMenu]="true" [showClearButton]="false">
            <ng-template pTemplate="filter" let-value let-filter="filterCallback">
              <p-dropdown [options]="stateOptions"
                          [showClear]="true"
                          (onChange)="filter($event.value)"
                          optionLabel="value"
                          appendTo="body"
                          placeholder="Select one">
                <ng-template let-option pTemplate="item">
                  <div class="flex">
                    <p-tag [value]="DisplayHelper.showState | wrapFn: option"
                           [severity]="DisplayHelper.getStateSeverity | wrapFn: option"></p-tag>
                  </div>
                </ng-template>
                <ng-template let-option pTemplate="selectedItem">
                  <div class="flex">
                    <p-tag [value]="DisplayHelper.showState | wrapFn: option"
                           [severity]="DisplayHelper.getStateSeverity | wrapFn: option"></p-tag>
                  </div>
                </ng-template>

              </p-dropdown>
            </ng-template>
          </p-columnFilter>
        </th>
        <th id="blank4"></th>
        <th id="blank5"></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-timeEntry let-rowIndex="rowIndex">
      <tr>
        <td>{{ timeEntry.startTime | date: 'ccc, MMM dd, y, HH:mm' }}</td>
        <td>{{ timeEntry.endTime | date: 'ccc, MMM dd, y, HH:mm' }}</td>
        <td>
          <p-dropdown [options]="availableProjects" [(ngModel)]="timeEntry.assignedProject"
                      (onChange)="updateProject($event.value, timeEntry.id)"
                      optionLabel="name"
                      placeholder="Select project"
                      appendTo="body"></p-dropdown>
        </td>
        <td>
          <p-tag [value]="DisplayHelper.showState | wrapFn: timeEntry.state"
                 [severity]="DisplayHelper.getStateSeverity | wrapFn: timeEntry.state"></p-tag>
        </td>
        <td (click)="onEditDescription(timeEntry)" class="cursor-pointer"
            (keydown)="onEditDescription(timeEntry)"
            [tabindex]="rowIndex"
        >{{ timeEntry?.description ?? 'Enter a description' }}
        </td>
        <td>
          <p-button (onClick)="this.onOpenSplitForm(timeEntry);">
            <i class="pi pi-pencil"></i>
          </p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <div class="pt-2">
    <p-card styleClass="text-lg text-center">
      {{ "The total worked time with the current filters is " + this.totalTime.hours + " hours and " + this.totalTime.minutes + " minutes." }}
    </p-card>
  </div>
</ng-container>
<ng-template #loading>
  <div class="flex justify-center">
    <p-progressSpinner ariaLabel="loading" />
  </div>
</ng-template>

<!-- Split time record dialog -->
<p-dialog *ngIf="this.selectedEntry" [(visible)]="this.splitVisible" (onHide)="splitForm.reset()" [modal]="true" position="bottomright">
  <form [formGroup]="splitForm" (ngSubmit)="this.splitForm.valid && this.onSplitFormSubmit()">
    <div class="text-lg pb-2"><strong>Split time record at:</strong></div>
    <p-calendar formControlName="time" class="pr-2"
                [showTime]="true"
                hourFormat="24"
                [minDate]="this.selectedEntry.startTime"
                [maxDate]="this.selectedEntry.endTime"
                appendTo="body"
    ></p-calendar>
    <p-button label="Confirm" type="submit" [disabled]="!this.splitForm.valid"></p-button>
    <br>
    <p-message *ngIf="this.splitForm.controls.time.errors?.['notInRange'] && this.splitForm.touched"
               [text]="'Time needs to be between ' + (this.selectedEntry.startTime | date: 'MM/dd/y HH:mm') + ' and ' + (this.selectedEntry.endTime | date: 'MM/dd/y HH:mm')" severity="error"
               styleClass="my-2"></p-message>
  </form>
</p-dialog>

<!-- Edit description dialog -->
<p-dialog [(visible)]="this.editDescriptionVisible" header="Edit description:"
          [modal]="true"
          (onHide)="this.descriptionForm.reset()">
  <form [formGroup]="descriptionForm" class="flex flex-col"
        (ngSubmit)="this.descriptionForm.value && this.onDescriptionFormSubmit()">
    <textarea class="w-[50vw] h-[10vw]" type="text" pInputTextarea formControlName="description"></textarea>
    <p-button label="Save" type="submit" [disabled]="!this.descriptionForm.dirty" class="pt-4"></p-button>
  </form>
</p-dialog>

